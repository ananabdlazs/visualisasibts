<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualisasi analisis BTS berdasarkan Cekpos</title> 
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <!-- BARU: Menambahkan Google Font 'Inter' -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
     
    <style>
        /* BARU: Menambahkan animasi fade-in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body {
            /* MODIFIKASI: Menggunakan font Inter */
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa; /* Warna latar sedikit diubah */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* BARU: Menerapkan animasi fade-in ke elemen utama */
        #header-branding, #controls, #analysis-summary, #map, #handover-note, #credit, h2, p {
            animation: fadeIn 0.6s ease-out both;
        }
        
        /* Memberi sedikit penundaan pada elemen di bawah */
        h2 { animation-delay: 0.05s; }
        #controls { animation-delay: 0.1s; }
        #analysis-summary { animation-delay: 0.15s; }
        p { animation-delay: 0.2s; }
        #map { animation-delay: 0.25s; }
        #handover-note { animation-delay: 0.3s; }
        #credit { animation-delay: 0.35s; }


        #header-branding {
            width: 90%;
            max-width: 1200px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px 0;
            background-color: #ffffff;
            border-bottom: 3px solid #0056b3; /* Border lebih tebal */
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); /* Bayangan lebih halus */
            margin-bottom: 20px;
            border-radius: 8px;
        }
        #main-title {
            font-size: 28px;
            font-weight: 700; /* Lebih tebal */
            text-align: center;
            flex-grow: 1;
            /* BARU: Gradien pada teks judul */
            background: linear-gradient(45deg, #0056b3, #007bff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
        h2 {
            color: #333;
            text-align: center;
            margin-top: 10px;
            font-weight: 700;
        }
        #map {
            height: 500px;
            width: 90%;
            max-width: 1200px;
            margin-top: 20px;
            border: 1px solid #dee2e6; /* Border lebih halus */
            border-radius: 12px; /* Sudut lebih bulat */
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        /* MODIFIKASI: Efek interaktif pada panel */
        #controls, #analysis-summary, #handover-note {
            width: 90%;
            max-width: 1200px;
            margin-top: 20px;
            padding: 20px; /* Padding lebih besar */
            background-color: #fff;
            border-radius: 12px; /* Sudut lebih bulat */
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            /* BARU: Transisi untuk efek hover */
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }

        /* BARU: Efek hover "lift" */
        #controls:hover, #analysis-summary:hover, #handover-note:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        #analysis-summary {
            border-left: 5px solid #007bff; 
        }
        #analysis-summary h4 {
            margin-top: 0;
            color: #0056b3;
            font-size: 18px; /* Sedikit lebih besar */
        }
        #analysis-summary p {
            margin: 10px 0; /* Jarak lebih */
            font-size: 15px;
        }
        #analysis-summary span {
            font-weight: 500; /* Sedang */
            color: #333;
            float: right; 
        }

        #dataInput {
            width: 98%;
            height: 150px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px; /* Sudut lebih bulat */
            padding: 10px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        /* BARU: Efek focus pada input */
        #dataInput:focus, #radius-inputs input:focus, #fileInput:focus-within {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
            outline: none;
        }

        /* MODIFIKASI: Efek tombol interaktif */
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 18px; /* Sedikit lebih besar */
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin-top: 10px;
            margin-right: 10px;
            /* BARU: Transisi dan bayangan */
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover {
            background-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px); /* Efek "lift" saat hover */
        }
        /* BARU: Efek saat tombol ditekan */
        button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        #clearButton {
            background-color: #dc3545;
        }
        #clearButton:hover {
            background-color: #a71d2a;
        }

        #radius-settings {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        #radius-settings h4 {
            width: 100%;
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }
        #radius-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 20px; 
            align-items: center;
        }
        #radius-inputs div {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #radius-inputs label {
            font-weight: 500;
            font-size: 14px;
        }
        #radius-inputs input {
            width: 80px;
            padding: 8px; /* Padding lebih */
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .legend {
            padding: 8px 12px; /* Padding lebih */
            font: 14px 'Inter', Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.9); /* Lebih solid */
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border-radius: 8px;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 1;
            border: 1px solid #555;
            border-radius: 50%;
        }
        #handover-note {
            background-color: #e9f7ef;
            border-left: 5px solid #28a745;
            font-size: 15px;
            line-height: 1.6;
            color: #333;
        }
        #handover-note h3 {
            margin-top: 0;
            color: #155724; /* Hijau lebih gelap */
        }
        #handover-note strong {
            color: #28a745;
        }
        #credit {
            width: 90%;
            max-width: 1200px;
            text-align: right;
            margin-top: 20px;
            font-size: 12px;
            color: #6c757d; /* Abu-abu */
            padding-bottom: 20px;
        }

        /* BARU: Styling untuk link download dan input file */
        #downloadTemplateLink {
            font-size: 13px; 
            color: #0056b3; 
            text-decoration: none; 
            font-weight: 500; 
            white-space: nowrap;
            transition: color 0.2s;
        }
        #downloadTemplateLink:hover {
            color: #007bff;
            text-decoration: underline;
        }
        input[type="file"] {
            font-size: 14px;
            color: #333;
        }
        /* Styling untuk tombol "Choose File" */
        input[type="file"]::file-selector-button {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #e9ecef;
        }

    </style>
</head>
<body>

    <div id="header-branding">
        <h1 id="main-title">Pusat Komando Operasi Interdiksi Terpadu</h1> 
    </div>

    <!-- Judul h2 dari permintaan sebelumnya -->
    <h2>Visualisasi analisis BTS berdasarkan Cekpos</h2> 

    <div id="controls">
        <!-- MODIFIKASI: Mengubah label untuk Opsi 1 -->
        <label for="dataInput"><strong>Opsi 1: Tempelkan Data JSON Anda di sini:</strong></label>
        <textarea id="dataInput" placeholder="Contoh format JSON:
[
  {
    &quot;lat&quot;: -6.175110,
    &quot;lng&quot;: 106.827219,
    &quot;waktu&quot;: &quot;2025-10-23 08:00:00&quot;,
    &quot;lac&quot;: &quot;9001&quot;,
    &quot;cellId&quot;: &quot;12345&quot;,
    &quot;tipeSinyal&quot;: &quot;4G&quot;
  },
  ...
]"></textarea>
        
        <!-- BARU: Menambahkan Opsi 2 untuk unggah file -->
        <div style="margin-top: 15px; margin-bottom: 15px; border-top: 1px solid #eee; padding-top: 15px;">
            <label for="fileInput" style="font-weight: bold; display: block; margin-bottom: 5px;">Opsi 2: Unggah File Data (.txt / .csv)</label>
            <!-- MODIFIKASI: Membungkus input dan link download dalam div -->
            <div style="display: flex; align-items: center; gap: 15px; margin-top: 5px;">
                <input type="file" id="fileInput" accept=".txt,.csv">
                <!-- BARU: Tautan untuk mengunduh template -->
                <a href="#" id="downloadTemplateLink" download="template_bts.csv">
                    Unduh Template Format
                </a>
            </div>
            <p style="font-size: 13px; font-style: italic; color: #555; margin-top: 5px; margin-bottom: 0;">
                <b>Format yang diharapkan:</b> CSV (Comma-Separated Values).<br>
                Baris pertama <b>harus</b> berisi header, contoh: <code>lat,lng,waktu,lac,cellId,tipeSinyal</code><br>
                Data di baris berikutnya harus sesuai urutan header.
            </p>
        </div>

        <div id="radius-settings">
            <h4>Estimasi Radius (dalam meter):</h4>
            <!-- KETERANGAN BARU DITAMBAHKAN DI SINI -->
            <p style="font-size: 13px; font-style: italic; color: #555; margin-top: -5px; margin-bottom: 10px;">
                Radius dapat di atur jika Analis memiliki perkiraan radius dari tim lapangan.
            </p>
            <div id="radius-inputs">
                <div>
                    <label for="radius2G">2G:</label>
                    <input type="number" id="radius2G" value="3000" step="100">
                </div>
                <div>
                    <label for="radius4G">4G:</label>
                    <input type="number" id="radius4G" value="1500" step="100">
                </div>
                <div>
                    <label for="radius5G">5G:</label>
                    <input type="number" id="radius5G" value="500" step="50">
                </div>
                <div>
                    <label for="radiusDefault">Default:</label>
                    <input type="number" id="radiusDefault" value="1000" step="100">
                </div>
            </div>
        </div>

        <button id="processButton">Proses Data</button>
        <button id="clearButton">Bersihkan Peta</button>
    </div>

    <div id="analysis-summary" style="display: none;">
        <h4>Ringkasan Analisis</h4>
        <p>Total Titik Data: <span id="summary-total-points">0</span></p>
        <p>Potensi Handover: <span id="summary-handovers">0</span></p>
        <p>Total Jarak Tempuh: <span id="summary-distance">0 km</span></p>
        <p>Total Durasi: <span id="summary-duration">N/A</span></p>
        <p>Kecepatan Rata-rata: <span id="summary-speed">N/A</span></p>
    </div>

    <p style="text-align: center; font-style: italic; width: 90%; max-width: 1200px; margin-top: 15px; margin-bottom: -10px; font-size: 14px;">
        Klik pada sebuah titik di peta untuk melihat estimasi radius jangkauannya.
    </p>

    <div id="map"></div>

    <!-- Judul catatan dari permintaan sebelumnya -->
    <div id="handover-note">
        <h3>Catatan Program</h3>
        <p>Ketika Anda bergerak dan berpindah dari satu menara sinyal (BTS) ke menara sinyal lainnya, proses ini disebut <strong>Handover</strong>. Ini terjadi agar koneksi internet atau telepon Anda tidak terputus.</p>
        
        <ul>
            <li><strong>Logika Program Saat Ini (V2 Multi-Check):</strong> Program ini menandai titik sebagai <strong>Potensi Handover</strong> (kuning) jika:
                <ol>
                    <li>Lokasi Anda saat itu terdeteksi masih berada dalam jangkauan sinyal (radius) dari <strong>SALAH SATU</strong> menara sebelumnya (bukan hanya yang terakhir).</li>
                    <li>DAN, data `Cell ID` Anda terdeteksi telah berubah dibandingkan `Cell ID` menara sebelumnya tersebut.</li>
                </ol>
            </li>
            <li><strong>Fitur Tumpang Tindih (Stacking):</strong> Jika beberapa titik data berada di lokasi yang sama persis, program akan menggabungkannya menjadi satu popup yang dapat di-scroll.</li>
            <li><strong>Tentang LAC & Cell ID:</strong> Handover selalu melibatkan perubahan Cell ID. Kode Area Lokasi (LAC) bisa tetap sama (handover intra-LAC) atau berubah (handover inter-LAC). Keduanya adalah bentuk handover yang valid.</li>
        </ul>
    </div>

    <div id="credit">
        Dibuat oleh: Operator Pusat Komando Operasi Interdiksi Terpadu
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
     
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // --- Inisialisasi Peta ---
            const map = L.map('map', { 
                preferCanvas: true 
            }).setView([-6.2088, 106.8456], 12); 

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            let dataLayer = L.layerGroup().addTo(map);

            // --- Referensi Elemen ---
            const processButton = document.getElementById('processButton');
            const clearButton = document.getElementById('clearButton');
            const dataInput = document.getElementById('dataInput');
            const summaryPanel = document.getElementById('analysis-summary');

            <!-- BARU: Referensi dan listener untuk input file -->
            const fileInput = document.getElementById('fileInput');

            fileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const fileContent = e.target.result;
                    try {
                        const jsonString = parseTxtToJSON(fileContent);
                        dataInput.value = jsonString;
                        console.log("File berhasil dibaca dan dikonversi ke JSON. Silakan klik 'Proses Data'.");
                    } catch (err) {
                        console.error("Gagal mem-parsing file TXT/CSV:", err.message);
                        dataInput.value = `Error: Gagal mem-parsing file.\nPastikan formatnya benar (CSV): baris pertama header, data dipisah koma.\n\nError: ${err.message}`;
                    }
                };
                
                reader.onerror = function() {
                    console.error("Gagal membaca file:", reader.error);
                    dataInput.value = `Error: Gagal membaca file. ${reader.error}`;
                };

                reader.readAsText(file);
                
                event.target.value = null;
            });

            <!-- BARU: Menyiapkan Link Download Template -->
            const templateCsvContent = 
`lat,lng,waktu,lac,cellId,tipeSinyal
-6.175110,106.827219,2025-10-23 08:00:00,9001,12345,4G
-6.176000,106.828000,2025-10-23 08:01:00,9001,54321,4G`;

            const downloadLink = document.getElementById('downloadTemplateLink');
            const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(templateCsvContent);
            downloadLink.href = dataUri;

            // --- Tambahkan Legenda ---
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                div.innerHTML =
                    '<h4>Legenda</h4>' +
                    '<i style="background: #007bff"></i> Titik Sinyal<br>' +
                    '<i style="background: #ffc107"></i> Potensi Handover';
                return div;
            };
            legend.addTo(map);

            <!-- BARU: Fungsi untuk mem-parsing TXT/CSV ke JSON String -->
            function parseTxtToJSON(txtContent) {
                const lines = txtContent.trim().split(/\r?\n/); 
                
                if (lines.length < 2) {
                    throw new Error("File harus memiliki setidaknya 2 baris (1 header, 1 data).");
                }

                const headers = lines[0].trim().split(',').map(h => h.trim());
                
                const requiredHeaders = ['lat', 'lng'];
                if (!requiredHeaders.every(h => headers.includes(h))) {
                    throw new Error("Header file (baris pertama) harus mengandung setidaknya 'lat' dan 'lng'.");
                }

                const jsonArray = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line === "") continue; 

                    const values = line.split(',');

                    const entry = {};
                    for (let j = 0; j < headers.length; j++) {
                        const key = headers[j];
                        let value = values[j] ? values[j].trim() : "";

                        if (value.startsWith('"') && value.endsWith('"')) {
                            value = value.substring(1, value.length - 1);
                        }

                        if (key === 'lat' || key === 'lng') {
                            entry[key] = parseFloat(value) || null; 
                        } else {
                            entry[key] = value; 
                        }
                    }

                    if (entry.lat != null && entry.lng != null) {
                        jsonArray.push(entry);
                    } else {
                        console.warn(`Melewatkan baris ${i+1} karena 'lat' or 'lng' tidak valid: ${line}`);
                    }
                }

                if (jsonArray.length === 0) {
                    throw new Error("Tidak ada data valid yang ditemukan dalam file (setelah header).");
                }

                return JSON.stringify(jsonArray, null, 2);
            }

            // --- FUNGSI HELPER ---

            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; 
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const distance = R * c; 
                return distance;
            }

            function getRadiusInMeters(tipeSinyal) {
                const r2G = parseInt(document.getElementById('radius2G').value) || 3000;
                const r4G = parseInt(document.getElementById('radius4G').value) || 1500;
                const r5G = parseInt(document.getElementById('radius5G').value) || 500;
                const rDef = parseInt(document.getElementById('radiusDefault').value) || 1000;

                const sinyal = String(tipeSinyal || '').toUpperCase();
                switch (sinyal) {
                    case '2G': return r2G;
                    case '4G': return r4G;
                    case '5G': return r5G;
                    default: return rDef;
                }
            }

            function parseDateTime(waktuStr) {
                if (!waktuStr) return null;
                const dateObj = new Date(waktuStr);
                if (isNaN(dateObj.getTime())) {
                    console.warn("Format waktu tidak valid:", waktuStr);
                    return null;
                }
                return dateObj;
            }

            function formatDuration(ms) {
                if (ms < 0) ms = 0;
                let seconds = Math.floor(ms / 1000);
                let minutes = Math.floor(seconds / 60);
                let hours = Math.floor(minutes / 60);
                let days = Math.floor(hours / 24);

                hours = hours % 24;
                minutes = minutes % 60;
                seconds = seconds % 60;

                let parts = [];
                if (days > 0) parts.push(days + " hari");
                if (hours > 0) parts.push(hours + " jam");
                if (minutes > 0) parts.push(minutes + " mnt");
                if (seconds > 0) parts.push(seconds + " dtk");

                return parts.join(', ') || "0 dtk";
            }
            
            const defaultMarkerStyle = {
                radius: 8,
                fillColor: "#007bff", // Biru
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.9
            };
            const handoverMarkerStyle = {
                radius: 8,
                fillColor: "#ffc107", // Kuning
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.9
            };

            // --- FUNGSI UTAMA ---
            function processData() {
                dataLayer.clearLayers();
                let inputText = dataInput.value;
                if (!inputText.trim()) {
                    console.error("Input data kosong.");
                    return;
                }

                let dataPoints;
                try {
                    dataPoints = JSON.parse(inputText);
                    if (!Array.isArray(dataPoints)) {
                        throw new Error("Data harus berupa array JSON.");
                    }
                } catch (e) {
                    console.error("Error parsing JSON:", e.message);
                    return;
                }

                if (dataPoints.length === 0) {
                    console.warn("Array data JSON kosong.");
                    return;
                }

                const latLngs = []; 
                const locationMap = new Map(); 

                let totalPointsProcessed = 0;
                let totalHandovers = 0;
                let totalDistance = 0;
                let firstTime = null;
                let lastTime = null;

                dataPoints.forEach((point, index) => {
                    if (point.lat == null || point.lng == null) {
                        console.warn("Melewatkan titik karena data lat/lng tidak ada:", point);
                        return;
                    }

                    totalPointsProcessed++;
                    const lat = point.lat;
                    const lng = point.lng;
                    latLngs.push([lat, lng]);

                    const currentTime = parseDateTime(point.waktu);
                    if (currentTime) {
                        if (!firstTime) firstTime = currentTime; 
                        lastTime = currentTime; 
                    }

                    if (index > 0) {
                        const prevPoint = dataPoints[index - 1];
                        if (prevPoint.lat != null && prevPoint.lng != null) {
                            totalDistance += calculateDistance(prevPoint.lat, prevPoint.lng, lat, lng);
                        }
                    }

                    let isHandover = false;
                    let markerStyle = defaultMarkerStyle;
                    const radiusMeters = getRadiusInMeters(point.tipeSinyal);
                    let handoverReasons = []; 

                    for (let j = 0; j < index; j++) {
                        const sourcePoint = dataPoints[j];
                        if (sourcePoint.lat == null || sourcePoint.lng == null) {
                            continue; 
                        }

                        const sourceRadiusMeters = getRadiusInMeters(sourcePoint.tipeSinyal);
                        const distanceToSource_km = calculateDistance(sourcePoint.lat, sourcePoint.lng, lat, lng);
                        
                        const inSourceRadius = (distanceToSource_km * 1000) <= sourceRadiusMeters;
                        const cellIdChanged = point.cellId != null && 
                                              sourcePoint.cellId != null && 
                                              point.cellId !== sourcePoint.cellId;

                        if (inSourceRadius && cellIdChanged) {
                            isHandover = true; 
                            markerStyle = handoverMarkerStyle; 
                            
                            const lacChanged = (point.lac != null && 
                                               sourcePoint.lac != null && 
                                               point.lac !== sourcePoint.lac);
                            
                            let handoverType = (point.lac == null || sourcePoint.lac == null) ? "Handover" : (lacChanged ? "Inter-LAC" : "Intra-LAC");

                            let reason = `<br><small style='color: #555; line-height: 1.5;'>
                                (<b>Potensi Handover ${handoverType}</b> dari <b>Titik #${j + 1}</b>.<br>
                                Jarak: ${distanceToSource_km.toFixed(2)} km.<br>
                                Masih dalam est. radius ${(sourceRadiusMeters / 1000).toFixed(1)} km dari Titik #${j + 1})
                                </small>`;
                            
                            handoverReasons.push(reason);
                        }
                    } 

                    if (isHandover) {
                        totalHandovers++;
                    }

                    const combinedHandoverReason = handoverReasons.join(""); 

                    let popupContent = `
                        <b>Titik:</b> ${index + 1}<br>
                        <b>Waktu:</b> ${point.waktu || 'N/A'}<br>
                        <b>LAC:</b> ${point.lac || 'N/A'}<br>
                        <b>Cell ID:</b> ${point.cellId || 'N/A'}<br>
                        <b>Tipe Sinyal:</b> ${point.tipeSinyal || 'N/A'} (Est. ${(radiusMeters/1000).toFixed(1)} km)<br>
                        <b>Status:</b> ${isHandover ? 'Potensi Handover' : 'Titik Sinyal'}
                        ${combinedHandoverReason} 
                    `;
                    
                    if (index < dataPoints.length - 1) {
                        const nextPoint = dataPoints[index + 1];
                        if (nextPoint.lat != null && nextPoint.lng != null) {
                            const distanceToNext = calculateDistance(lat, lng, nextPoint.lat, nextPoint.lng);
                            popupContent += `<br><b>Jarak ke titik berikutnya:</b> ${distanceToNext.toFixed(2)} km`;
                        }
                    } else {
                        popupContent += `<br><b>Ini adalah titik terakhir.</b>`;
                    }

                    const coordKey = `${lat},${lng}`;
                    let pointsAtLocation = locationMap.get(coordKey) || [];
                    pointsAtLocation.push({
                        popupContent: popupContent,
                        style: markerStyle,
                        radius: radiusMeters
                    });
                    locationMap.set(coordKey, pointsAtLocation);
                }); 

                locationMap.forEach((points, coordKey) => {
                    const [lat, lng] = coordKey.split(',').map(Number);
                    const lastPoint = points[points.length - 1];
                    const finalStyle = lastPoint.style;
                    const finalRadius = lastPoint.radius;

                    const combinedPopupContent = points.map(p => p.popupContent)
                                                     .join("<hr style='border: 0; border-top: 1px dashed #ccc; margin: 10px 0;'>");
                    
                    const marker = L.circleMarker([lat, lng], finalStyle)
                        .addTo(dataLayer)
                        .bindPopup(combinedPopupContent, { maxHeight: 400 });

                    const circleRadius = L.circle([lat, lng], {
                        radius: finalRadius,
                        color: finalStyle.fillColor, 
                        weight: 2,
                        fillOpacity: 0.1
                    });
                    
                    marker.on('popupopen', () => circleRadius.addTo(dataLayer));
                    marker.on('popupclose', () => dataLayer.removeLayer(circleRadius));
                });

                if (latLngs.length > 1) {
                    const polyline = L.polyline(latLngs, {
                        color: 'red',
                        weight: 3,
                        opacity: 0.7
                    }).addTo(dataLayer);
                    map.fitBounds(polyline.getBounds());
                } else if (latLngs.length === 1) {
                    map.setView(latLngs[0], 15);
                }

                let totalDurationString = "N/A";
                let avgSpeedString = "N/A";

                if (firstTime && lastTime && lastTime > firstTime) {
                    const durationMs = lastTime - firstTime;
                    totalDurationString = formatDuration(durationMs);
                    
                    const totalDurationHours = durationMs / (1000 * 60 * 60);
                    if (totalDistance > 0 && totalDurationHours > 0) {
                        const avgSpeed = totalDistance / totalDurationHours; // km/j
                        avgSpeedString = avgSpeed.toFixed(2) + " km/j";
                    }
                }

                summaryPanel.style.display = 'block';
                document.getElementById('summary-total-points').textContent = totalPointsProcessed;
                document.getElementById('summary-handovers').textContent = totalHandovers;
                document.getElementById('summary-distance').textContent = totalDistance.toFixed(2) + " km";
                document.getElementById('summary-duration').textContent = totalDurationString;
                document.getElementById('summary-speed').textContent = avgSpeedString;
            }
            
            function clearMap() {
                dataLayer.clearLayers(); 
                dataInput.value = ""; 
                
                summaryPanel.style.display = 'none'; 
                
                document.getElementById('summary-total-points').textContent = "0";
                document.getElementById('summary-handovers').textContent = "0";
                document.getElementById('summary-distance').textContent = "0 km";
                document.getElementById('summary-duration').textContent = "N/A";
                document.getElementById('summary-speed').textContent = "N/A";

                document.getElementById('radius2G').value = "3000";
                document.getElementById('radius4G').value = "1500";
                document.getElementById('radius5G').value = "500";
                document.getElementById('radiusDefault').value = "1000";

                console.log("Peta dan input telah dibersihkan.");
            }

            processButton.addEventListener('click', processData);
            clearButton.addEventListener('click', clearMap);

        });
    </script>
    
</body>
</html>